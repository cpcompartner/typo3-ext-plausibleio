stages:
  - build_ci
  - ci
variables:
  COMPOSER_COMMAND: "composer update --with=typo3/cms-core:dev-master"

build-dev:
  stage: build_ci
  image: $CI_REGISTRY/waldhacker/mainframe/docker/base/php/7.4:cli
  needs: []
  tags:
    - common
  script:
    - composer self-update
    - $COMPOSER_COMMAND
  artifacts:
    name: TYPO3
    paths:
      - .build/
      - ./composer.lock
    expire_in: '1h'

lintphp:
  stage: ci
  image: $CI_REGISTRY/waldhacker/mainframe/docker/base/php/7.4:cli
  tags:
    - common
  needs:
    - build-dev
  script:
    - composer run ci:lint:php

stan:
  stage: ci
  image: $CI_REGISTRY/waldhacker/mainframe/docker/base/php/7.4:cli
  tags:
    - common
  needs:
    - build-dev
  script:
    - composer run ci:stan

tests:
  stage: ci
  image: $CI_REGISTRY/waldhacker/mainframe/docker/base/php/7.4:cli
  tags:
    - common
  needs:
    - build-dev
  script:
    - composer run ci:tests:unit
  artifacts:
    reports:
      junit: .build/logs/junit.xml
